name: Deploy ASP.NET 8 API-ABRASF no Windows Server

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout do Código
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
      env:
        # Resolve o erro de permissão na instalação do SDK
        DOTNET_INSTALL_DIR: 'C:\actions-runner\dotnet'

    - name: Build e Publish
      run: |
        dotnet restore
        # O output vai para uma pasta temporária dentro do workspace do runner
        dotnet publish -c Release -o ./publish_output
    - name: Deploy no IIS
      shell: powershell
      run: |
        # Configuração de Nomes
        $dest = "C:\inetpub\wwwroot\NFSE-API" # Certifique-se que esta pasta existe no servidor
        $name = "NFSE-ABRASF-API"             # Nome exato do Site e do Pool

        # 1. Preparação: Cria app_offline para liberar arquivos travados
        if (!(Test-Path $dest)) { New-Item -Path $dest -ItemType Directory -Force }
        New-Item -Path "$dest\app_offline.htm" -ItemType File -Force
        Write-Host "Aguardando o IIS liberar os arquivos da API..."
        Start-Sleep -Seconds 5

        # 2. Gerenciamento do IIS (Importa módulo e para o Pool)
        Import-Module WebAdministration
        try {
            Write-Host "Parando o Application Pool e o Site..."
            Stop-WebAppPool -Name $name
            Stop-IISSite -Name $name
            Start-Sleep -Seconds 2
        } catch {
            Write-Warning "Aviso: Não foi possível parar o Pool ou Site. Verifique se os nomes estão corretos no IIS."
        }

        # 3. Deploy: Copia os binários novos do .NET 8
        Write-Host "Copiando novos arquivos para $dest..."
        Copy-Item -Path "./publish/*" -Destination $dest -Recurse -Force

        # 4. Finalização: Remove trava e reinicia a API
        if (Test-Path "$dest\app_offline.htm") { Remove-Item -Path "$dest\app_offline.htm" -Force }
        
        try {
            Write-Host "Reiniciando a API..."
            Start-WebAppPool -Name $name
            Start-IISSite -Name $name
            Write-Host "Deploy finalizado com sucesso!"
        } catch {
            Write-Error "Erro ao reiniciar a API no IIS."
            exit 1
        }