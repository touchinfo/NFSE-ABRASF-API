name: Deploy ASP.NET 8 API-ABRASF no Windows Server

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout do CÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
      env:
        DOTNET_INSTALL_DIR: 'C:\actions-runner\dotnet'
    
    - name: Restore Dependencies
      run: dotnet restore
    
    - name: Build e Publish
      run: dotnet publish -c Release -o ./publish_output
    
    - name: Deploy no IIS
      shell: powershell
      run: |
        $dest = "C:\inetpub\wwwroot\API-ABRASF"
        $siteName = "API-ABRASF"
        $poolName = "API-ABRASF"
        
        Write-Host "Iniciando deploy..."
        
        if (!(Test-Path $dest)) { 
            New-Item -Path $dest -ItemType Directory -Force 
        }
        
        if (!(Test-Path "$dest\logs")) {
            New-Item -Path "$dest\logs" -ItemType Directory -Force
        }
        
        New-Item -Path "$dest\app_offline.htm" -ItemType File -Force | Out-Null
        Start-Sleep -Seconds 5
        
        Import-Module WebAdministration
        
        Stop-WebAppPool -Name $poolName -ErrorAction SilentlyContinue
        Stop-IISSite -Name $siteName -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 3
        
        Copy-Item -Path "./publish_output/*" -Destination $dest -Recurse -Force
        
        Remove-Item -Path "$dest\app_offline.htm" -Force -ErrorAction SilentlyContinue
        
        Start-WebAppPool -Name $poolName
        Start-IISSite -Name $siteName
        
        Write-Host "Deploy concluido!"