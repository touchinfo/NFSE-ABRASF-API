name: Deploy ASP.NET 8 API-ABRASF no Windows Server

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout do Código
      uses: actions/checkout@v4
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
      env:
        DOTNET_INSTALL_DIR: 'C:\actions-runner\dotnet'
    
    - name: Restore Dependencies
      run: dotnet restore
    
    - name: Build e Publish
      run: dotnet publish -c Release -o ./publish_output
    
    - name: Deploy no IIS
      shell: powershell
      run: |
        # ===== CONFIGURAÇÕES =====
        $dest = "C:\inetpub\wwwroot\API-ABRASF"  # Pasta final dos binários
        $siteName = "API-ABRASF"                  # Nome do Site no IIS
        $poolName = "API-ABRASF"                  # Nome do Application Pool
        
        # ===== PREPARAÇÃO =====
        Write-Host "Iniciando deploy para $dest..."
        
        # Cria a pasta se não existir
        if (!(Test-Path $dest)) { 
            New-Item -Path $dest -ItemType Directory -Force 
            Write-Host "Pasta criada: $dest"
        }
        
        # Cria app_offline.htm para liberar arquivos travados pelo IIS
        New-Item -Path "$dest\app_offline.htm" -ItemType File -Force | Out-Null
        Write-Host "App offline criado. Aguardando IIS liberar arquivos..."
        Start-Sleep -Seconds 5
        
        # ===== PARAR IIS =====
        Import-Module WebAdministration
        
        try {
            Write-Host "Parando Application Pool: $poolName"
            Stop-WebAppPool -Name $poolName -ErrorAction SilentlyContinue
            
            Write-Host "Parando Site: $siteName"
            Stop-IISSite -Name $siteName -ErrorAction SilentlyContinue
            
            Start-Sleep -Seconds 3
        } catch {
            Write-Warning "Não foi possível parar o Pool/Site. Continuando deploy..."
        }
        
        # ===== DEPLOY DOS BINÁRIOS =====
        Write-Host "Copiando arquivos compilados de ./publish_output para $dest..."
        
        # CORREÇÃO: Caminho correto é publish_output, não publish
        Copy-Item -Path "./publish_output/*" -Destination $dest -Recurse -Force
        
        Write-Host "Arquivos copiados com sucesso!"
        
        # ===== REMOVER APP_OFFLINE =====
        if (Test-Path "$dest\app_offline.htm") { 
            Remove-Item -Path "$dest\app_offline.htm" -Force 
        }
        
        # ===== REINICIAR IIS =====
        try {
            Write-Host "Iniciando Application Pool: $poolName"
            Start-WebAppPool -Name $poolName
            
            Write-Host "Iniciando Site: $siteName"
            Start-IISSite -Name $siteName
            
            Write-Host "✅ Deploy finalizado com sucesso!"
            Write-Host "API disponível em: http://localhost (conforme configuração do IIS)"
        } catch {
            Write-Error "❌ Erro ao reiniciar a API no IIS."
            exit 1
        }